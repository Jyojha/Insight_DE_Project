<head>
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
          integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
          crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
        integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
        crossorigin=""/>
  <script src="https://unpkg.com/jquery@3.2.1"></script>

  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>

<body onload="init();">
  <div style="width: 100%; height: 75%;" id="mapid"></div>
  <div class="ui-widget">
    <label for="source_street1">Source Intersecting_Street1: </label>
    <input id="source_street1">
  </div>
  <div class="ui-widget">
    <label for="source_street2">Source Intersecting_Street2: </label>
    <input id="source_street2">
  </div>
  <div class="ui-widget">
    <label for="destination_street1">Destination Intersecting_Street1: </label>
    <input id="destination_street1">
  </div>
  <div class="ui-widget">
    <label for="destination_street2">Destination Intersecting_Street2: </label>
    <input id="destination_street2">
  </div>
  <script type="text/javascript">

var map;
function init() {
    map = L.map('mapid');
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
    }).addTo(map);

    initStreetControls();


    map.setView([37.774929,-122.419416], 13);

    findPath(22881000, 33620000);
}

var src_street1;
var src_street2;
var dst_street1;
var dst_street2;

var src_cnn;
var dst_cnn;

function initStreetControls() {
  src_street1 = $("#source_street1");
  src_street2 = $("#source_street2");
  dst_street1 = $("#destination_street1");
  dst_street2 = $("#destination_street2");

  src_street1.autocomplete({
    source: matchingStreetSource,
    minLength: 3
  });

  src_street2.autocomplete({
    source: function(request, responseCallback) {
      intersectingStreetSource(src_street1, request, responseCallback);
    },
    select: function (event, ui) {
      src_cnn = ui.item.value;
      ui.item.value = ui.item.label;
    },
    minLength: 0
  });

  dst_street1.autocomplete({
    source: matchingStreetSource,
    minLength: 3
  });

 dst_street2.autocomplete({
    source: function(request, responseCallback) {
      intersectingStreetSource(dst_street1, request, responseCallback);
    },
    select: function (event, ui) {
      dst_cnn = ui.item.value;
      ui.item.value = ui.item.label;
    },
    minLength: 0
  });
}

function matchingStreetSource(request, responseCallback) {
  var data = {term: request.term};

  $.ajax("/api/matching_streets", {data: data}).done(function (response) {
    responseCallback(response.candidates);
  });
}

function intersectingStreetSource(streetOneInput, request, responseCallback) {
  var street = streetOneInput.val();
  var data = {street: street};

  $.ajax("/api/intersecting_streets", {data: data}).done(function (response) {
    var result = [];

    for (i in response.streets) {
      var street = response.streets[i];
      var name = street[0];
      var cnn = street[1];

      result.push({label: name, value: cnn});
    }

    responseCallback(result);
  });

}

function findPath(from_cnn, to_cnn) {
  var data = {from_cnn: from_cnn, to_cnn: to_cnn};
  //when you make a request for a path, it passes the data on success and then use the data for processing
  $.ajax("/api/find_path/", {data: data}).done(renderPath);
}

var route;
var markers = [];

function removePath() {
  if (route != undefined) {
    route.remove();
    route = undefined;
  }

  for (i in markers) {
    markers[i].remove();
  }

  markers = [];
}

function renderPath(response) {
  removePath();

  route = L.polyline([], {"color": 'blue'});

  for (i in response.path) {
    var segment = response.path[i];
    var marker;

    if (i == 0){
      marker = L.circleMarker(segment.from_coords, {"radius": 5, "color":'darkorange', "fillOpacity": 0.8}).addTo(map);
    } else {
      marker = L.circleMarker(segment.from_coords, {"radius": 5, "fillOpacity": 0.8}).addTo(map);
    }

    markers.push(marker);

    for (j in segment.centerline) {
      route.addLatLng(segment.centerline[j]);
    }

  }

  route.addTo(map);

  var array_len = response.path.length;
  marker = L.circleMarker(response.path[array_len-1].to_coords, {"radius": 5, "color": 'green', "fillOpacity": 0.8}).addTo(map);
  markers.push(marker);
}
  </script>
<body>
